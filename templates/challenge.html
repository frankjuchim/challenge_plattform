{% extends "base.html" %}
{% block content %}

<h2 class="mb-3">ğŸ§© Social Coding Event</h2>

{% if not challenge %}
<div class="event-card text-secondary">
  Noch ist kein Event aktiv â€“ lehnt euch zurÃ¼ck â˜•
</div>

{% else %}

<!-- Team + Challenge -->
<div class="mb-3 text-secondary">
  Team <strong>{{ team }}</strong> Â· {{ challenge.title }}
</div>

<!-- Statusanzeige -->
{% if challenge.paused %}
<div class="event-card mb-3 text-warning">
  â¸ <strong>Challenge pausiert</strong><br>
  Abgaben sind aktuell deaktiviert.
</div>
{% else %}
<div class="event-card mb-3 text-success">
  ğŸŸ¢ <strong>Challenge lÃ¤uft</strong><br>
  Abgaben sind mÃ¶glich.
</div>
{% endif %}

<!-- Aufgaben -->
<div class="row g-3">

  {% for task in tasks %}
  <div class="col-md-6">
    <div class="event-card h-100">

      <h5>{{ task.title }}</h5>
      <!-- Markdown Rendering -->
      <div class="text-secondary task-description">
        {{ task.description | markdown }}
      </div>

      <small class="text-secondary">
        Max. Punkte: {{ task.max_points }}
      </small>

      <hr>

      {% if task.id in submission_map %}
      <span class="badge bg-success">
        âœ” Abgegeben ({{ submission_map[task.id].points if submission_map[task.id].points is not none else '?' }} Punkte)
      </span>

      {% if submission_map[task.id].feedback %}
      <div class="mt-2 p-2 rounded bg-dark border border-secondary text-light small">
        <strong>Feedback:</strong> {{ submission_map[task.id].feedback }}
      </div>
      {% endif %}

      {% else %}
      <form method="post" action="{{ url_for('challenge.submit_task', task_id=task.id) }}" enctype="multipart/form-data"
        class="{% if challenge.paused %}opacity-50{% endif %}">

        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="mb-2">
          <small class="text-secondary d-block mb-1">Erlaubtes Format: <strong>{{ task.allowed_extension
              }}</strong></small>
          <input type="file" name="file" accept="{{ task.allowed_extension }}" class="form-control" {% if
            challenge.paused %}disabled{% endif %} required>
        </div>

        <button class="btn btn-outline-light w-100" {% if challenge.paused %}disabled{% endif %}>
          ğŸ“¤ Abgeben
        </button>

        {% if challenge.paused %}
        <small class="text-warning d-block mt-2">
          â¸ Upload wÃ¤hrend Pause nicht mÃ¶glich
        </small>
        {% endif %}
      </form>
      {% endif %}

    </div>
  </div>
  {% endfor %}

</div>
{% endif %}

<!-- Auto-Refresh alle 15 Sekunden -->
<!-- Auto-Refresh removed because it interrupts file upload -->
<!-- <script>
  setTimeout(() => {
    location.reload();
  }, 15000);
</script> -->

{% endblock %}