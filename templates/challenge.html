{% extends "base.html" %}
{% block content %}

<h2>Aktive Challenge</h2>

{% if message %}
  <p class="blocked">{{ message }}</p>
{% endif %}

{% if challenge %}
  <p><strong>Team:</strong> {{ team }}</p>
  <p><strong>Challenge:</strong> {{ challenge.title }}</p>

  {% if status == "RUNNING" %}
    <p class="timer">⏱ Restzeit: <span id="timer"></span></p>
  {% elif status == "FINISHED" %}
    <p class="blocked">⛔ Zeit abgelaufen</p>
  {% endif %}

  <ul>
  {% for task in tasks %}
    <li>
      <strong>{{ task.title }}</strong><br>
      {{ task.description }}<br>
      <em>Max Punkte: {{ task.max_points }}</em><br><br>

      {% if task.id in submission_map %}
        <span class="ok">✅ Abgabe erfolgt</span><br>
        <strong>Punkte:</strong> {{ submission_map[task.id].points }}<br>
        {% if submission_map[task.id].comment %}
          <em>Kommentar:</em> {{ submission_map[task.id].comment }}
        {% endif %}
      {% else %}
        {% if status == "RUNNING" %}
          <form method="post"
                action="/submit/{{ task.id }}"
                enctype="multipart/form-data">

            <input type="file"
                   name="file"
                   accept=".pde"
                   required>

            <br>
            <button type="submit">Abgeben</button>
          </form>
        {% else %}
          <span class="blocked">⛔ Keine Abgabe möglich</span>
        {% endif %}
      {% endif %}
    </li>
  {% endfor %}
  </ul>
{% endif %}

{% if status == "RUNNING" %}
<script>
let remaining = {{ remaining }};
const timer = document.getElementById("timer");

function updateTimer() {
  if (remaining <= 0) location.reload();
  const min = Math.floor(remaining / 60);
  const sec = remaining % 60;
  timer.innerText =
    String(min).padStart(2, '0') + ":" + String(sec).padStart(2, '0');
  remaining--;
}
updateTimer();
setInterval(updateTimer, 1000);
</script>
{% endif %}

{% endblock %}
